<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Transfer Tetris Earnings to TIFFY</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bignumber.js@9.0.2/bignumber.min.js"></script>
<style>
  body {
    background: radial-gradient(circle at top, #020024, #090979, #000);
    color: #0ff;
    font-family: 'Orbitron', sans-serif;
    text-align: center;
    padding: 20px;
  }
  h1 {
    text-shadow: 0 0 20px #00faff, 0 0 40px #00faff;
    margin-bottom: 30px;
  }
  .card {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border: 1px solid #0ff;
    border-radius: 12px;
    display: inline-block;
    box-shadow: 0 0 20px #0ff, inset 0 0 30px rgba(0,255,255,0.2);
    backdrop-filter: blur(10px);
    margin-top: 20px;
  }
  .btn {
    margin-top: 20px;
    padding: 14px 30px;
    font-size: 18px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.3s ease;
  }
  /* Connect Button Style */
  #connectBtn {
    background: rgba(0, 200, 255, 0.15);
    border: 1px solid #0ff;
    color: #0ff;
    box-shadow: 0 0 20px #00faff, 0 0 40px #00faff;
    backdrop-filter: blur(8px);
    animation: pulseBlue 1.8s infinite;
  }
  #connectBtn:hover {
    background: rgba(0, 200, 255, 0.3);
    transform: scale(1.05);
    box-shadow: 0 0 30px #00faff, 0 0 60px #00faff;
  }
  @keyframes pulseBlue {
    0% { box-shadow: 0 0 15px #00faff, 0 0 25px #00faff; }
    50% { box-shadow: 0 0 35px #00faff, 0 0 60px #00faff; }
    100% { box-shadow: 0 0 15px #00faff, 0 0 25px #00faff; }
  }
  /* Transfer Button Style */
  .transfer {
    background: rgba(255, 20, 147, 0.2);
    border: 1px solid hotpink;
    color: hotpink;
    box-shadow: 0 0 20px hotpink, 0 0 40px hotpink;
    animation: pulsePink 1.5s infinite;
  }
  .transfer:hover {
    background: rgba(255, 20, 147, 0.3);
    transform: scale(1.05);
    box-shadow: 0 0 30px hotpink, 0 0 60px hotpink;
  }
  @keyframes pulsePink {
    0% { box-shadow: 0 0 15px hotpink, 0 0 25px hotpink; }
    50% { box-shadow: 0 0 35px hotpink, 0 0 60px hotpink; }
    100% { box-shadow: 0 0 15px hotpink, 0 0 25px hotpink; }
  }
</style>
</head>
<body>

<h1>🚀 Transfer Tetris Earnings</h1>

<audio id="clickSound" src="click.wav" preload="auto"></audio>

<button id="connectBtn" class="btn">Connect Wallet</button>

<div class="card" id="transferCard" style="display:none">
  <div><strong>Wallet:</strong> <span id="walletAddress"></span></div>
  <div><strong>Claimed TIFFY:</strong> <span id="claimed">0</span></div>
  <div><strong>Tetris Earnings:</strong> <span id="tetris">0</span></div>
  <div style="margin-top:10px;font-size:18px"><strong>Total Withdrawable:</strong> <span id="total">0</span></div>
  <button class="btn transfer" id="transferBtn" style="display:none">Transfer Now</button>
</div>

<script>
(async ()=>{
  let web3, provider, account, tiffyContract, tiffyDecimals;
  const clickSound = document.getElementById("clickSound");

  // Define your TiffyAI contract details
  // IMPORTANT: REPLACE THIS WITH YOUR ACTUAL TIFFYAI CONTRACT ADDRESS
  const TIFFY_TOKEN_ADDRESS = "0x2a234d5Cc7431B824723c84c8605fD3968BF0255"; // Example address
  // A simplified ABI with just `decimals()` and `transfer()`
  const TIFFY_TOKEN_ABI = [
    { "constant": true, "inputs": [], "name": "decimals", "outputs": [{"name": "", "type": "uint8"}], "payable": false, "stateMutability": "view", "type": "function" },
    { "constant": false, "inputs": [{ "name": "recipient", "type": "address" }, { "name": "amount", "type": "uint256" }], "name": "transfer", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }
  ];

  const wModal = new Web3Modal.default({
    cacheProvider: false, // Set to true if you want to remember connected wallet
    providerOptions: {
      walletconnect: {
        package: window.WalletConnectProvider?.default || {},
        options: {
          rpc: { 56: "https://bsc-dataseed.binance.org/" }, // BNB Smart Chain (Mainnet)
          chainId: 56 // Specify chainId for WalletConnect
        }
      }
    }
  });

  document.getElementById("connectBtn").onclick = async() => {
    clickSound.play();
    try {
      provider = await wModal.connect();
      web3 = new Web3(provider);

      const cid = await web3.eth.getChainId();
      if(cid !== 56){
        try {
          await provider.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x38" }] }); // 0x38 is hex for 56
          // After switching, re-get chainId to ensure it's correct
          const newCid = await web3.eth.getChainId();
          if (newCid !== 56) {
            alert("❗ Failed to switch to BNB Smart Chain. Please switch manually.");
            return;
          }
        }
        catch(e){
          console.error("Error switching chain:", e);
          if (e.code === 4902 || e.message.includes("does not support adding new chains")) { // Code for chain not added or wallet doesn't support adding
             alert("❗ Please manually add BNB Smart Chain to your wallet or switch to it.");
          } else {
             alert("❗ Please switch to BNB Smart Chain.");
          }
          return;
        }
      }

      const accts = await web3.eth.getAccounts();
      account = accts[0];

      // Initialize the contract instance and get decimals
      tiffyContract = new web3.eth.Contract(TIFFY_TOKEN_ABI, TIFFY_TOKEN_ADDRESS);
      tiffyDecimals = await tiffyContract.methods.decimals().call();
      console.log("TIFFY Token Decimals:", tiffyDecimals);

      document.getElementById("walletAddress").textContent = account;
      document.getElementById("connectBtn").style.display = "none";
      document.getElementById("transferCard").style.display = "inline-block";
      loadBalances();

      // Listen for account or chain changes from the wallet provider
      provider.on("accountsChanged", (accounts) => {
        if (accounts.length > 0) {
          account = accounts[0];
          document.getElementById("walletAddress").textContent = account;
          loadBalances();
        } else {
          // No accounts found, user disconnected or changed
          alert("Wallet disconnected.");
          window.location.reload(); // Reload to reset state
        }
      });

      provider.on("chainChanged", (chainId) => {
        // Handle chain changes
        if (parseInt(chainId, 16) !== 56) { // chainId is usually hex from provider.on
          alert("Wallet switched to an unsupported chain. Please switch to BNB Smart Chain.");
          // Optionally reload or disable features
        } else {
            window.location.reload(); // Reload to re-initialize web3 and contract with correct chain
        }
      });

    } catch (e) {
      console.error("Wallet connection failed:", e);
      alert("Error connecting wallet. Please ensure you have a Web3 wallet installed.");
    }
  };

  // These functions now use BigNumber to handle decimals
  function getClaimed(){
    // Get the claimed amount as a string and create a BigNumber instance
    const claimedStr = localStorage.getItem(`tiffyClaimed_${account}`) || "0";
    return new BigNumber(claimedStr);
  }

  function getTetris(){
    // Get the tetris score as a string and create a BigNumber instance
    const tetrisStr = localStorage.getItem("tetrusScore") || "0";
    return new BigNumber(tetrisStr);
  }

  function loadBalances(){
    const claimed = getClaimed();
    const tetris = getTetris();
    // Perform addition with BigNumber and format for display
    const total = claimed.plus(tetris);

    // .toFixed() ensures proper decimal display, adjust the number for your desired precision
    // For example, .toFixed(2) for 0.02, .toFixed(5) for 0.00005 etc.
    // Make sure it's consistent with how you want to show your game points.
    document.getElementById("claimed").textContent = claimed.toFixed(5); // Adjusted for more precision
    document.getElementById("tetris").textContent = tetris.toFixed(5); // Adjusted for more precision
    document.getElementById("total").textContent = total.toFixed(5); // Adjusted for more precision
    document.getElementById("transferBtn").style.display = tetris.gt(0) ? "inline-block" : "none";
  }

  document.getElementById("transferBtn").onclick = async () => {
    clickSound.play();
    const tetrisPoints = getTetris();

    if (tetrisPoints.isZero()) {
        alert("No Tetris earnings to withdraw.");
        return;
    }

    // Ensure wallet is connected before attempting transfer
    if (!account || !tiffyContract || !tiffyDecimals) {
      alert("Please connect your wallet first.");
      return;
    }

    try {
      // Convert the BigNumber score to the smallest unit for the blockchain transaction
      // This is the crucial step for handling decimals in smart contracts
      const amountWithDecimals = web3.utils.toBN(tetrisPoints.shiftedBy(tiffyDecimals).toFixed());
      
      console.log(`Preparing to send ${tetrisPoints.toFixed(tiffyDecimals)} TIFFY (raw: ${amountWithDecimals.toString()}) to ${account}`);

      // Perform the actual on-chain transfer
      // IMPORTANT: This 'transfer' call assumes the *user* is initiating a transfer from a wallet
      // that *already holds* the TIFFY tokens to their own address, which isn't typically how game withdrawals work.
      // For a proper game withdrawal, you'd usually have a game smart contract that holds the rewards
      // and a function like `withdrawEarnings(uint256 amount)` that the player calls.
      // This function would verify their off-chain score and then transfer tokens from the game contract.
      // Alternatively, if you mint new tokens, your contract's owner (ADMIN_OWNER) could call adminMint.
      // THIS CURRENT IMPLEMENTATION IS A PLACEHOLDER FOR YOUR ACTUAL WITHDRAWAL MECHANISM.
      // Replace or adapt this line based on your game's smart contract logic.
      // Example for an actual game withdrawal from a central game contract (conceptual):
      // const gameContract = new web3.eth.Contract(GAME_ABI, GAME_CONTRACT_ADDRESS);
      // await gameContract.methods.withdrawEarnings(amountWithDecimals).send({ from: account });

      // Example for calling your TiffyAI contract's `transfer` if the game's wallet is the 'from' address
      // THIS IS NOT TYPICAL FOR USER-INITIATED WITHDRAWALS UNLESS THE USER IS *SENDING* TOKENS TO THEMSELVES.
      // This would require the user's connected wallet to *hold* the tokens, which contradicts "earnings".
      // A more likely scenario is the game owner's backend sending the tokens.
      // If you are expecting the user to *pull* tokens, then a specific `withdraw` function is needed in a separate contract.
      // For now, I'm commenting out the actual send as the underlying withdrawal mechanism needs clarification for a safe impl.
      // await tiffyContract.methods.transfer(account, amountWithDecimals).send({ from: account });
      
      // Simulating a successful transaction for local storage update
      // In a real dApp, this localStorage update happens *after* the on-chain tx is confirmed.
      const claimedKey = `tiffyClaimed_${account}`;
      const claimed = getClaimed();
      const newTotal = claimed.plus(tetrisPoints);

      localStorage.setItem(claimedKey, newTotal.toString());
      localStorage.setItem("tetrusScore", "0"); // Clear earnings only after successful withdrawal

      loadBalances();
      alert(`✅ Transferred ${tetrisPoints.toFixed(5)} Tetris earnings to TIFFY! Check your wallet (simulated).`); // Clarified as simulated

    } catch (error) {
      console.error("Transfer failed:", error);
      alert("❗ Withdrawal failed. Please try again. Check console for details.");
    }
  };

})();
</script>

</body>
</html>
